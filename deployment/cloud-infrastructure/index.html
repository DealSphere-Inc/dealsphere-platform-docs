
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Complete Documentation for the DealSphere Platform (APIs, architecture, planning, QA, product, tech)">
      
      
        <meta name="author" content="DealSphere Team">
      
      
      
        <link rel="prev" href="../authentication-deployment/">
      
      
        <link rel="next" href="../environment-management/">
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Cloud Infrastructure - DealSphere Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="f5f5f5" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cloud-infrastructure-setup-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DealSphere Documentation" class="md-header__button md-logo" aria-label="DealSphere Documentation" data-md-component="logo">
      
  <img src="../../images/logo1.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DealSphere Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cloud Infrastructure
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="f5f5f5" data-md-color-accent="cyan"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="a9a9a9" data-md-color-accent="gray"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/DealSphere-Inc/dealsphere-platform-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../adr/" class="md-tabs__link">
          
  
  
  Architecture Decision Records (ADRs)

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../planning/phase1-epics/" class="md-tabs__link">
          
  
  
  Planning

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../product/Phase1_PRD/" class="md-tabs__link">
          
  
  
  Product

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qa/" class="md-tabs__link">
          
  
  
  QA & Compliance

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../development/local-cicd-setup/" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Deployment

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tech/tech-landscape/" class="md-tabs__link">
          
  
  
  Technical Documentation

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DealSphere Documentation" class="md-nav__button md-logo" aria-label="DealSphere Documentation" data-md-component="logo">
      
  <img src="../../images/logo1.png" alt="logo">

    </a>
    DealSphere Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DealSphere-Inc/dealsphere-platform-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture Decision Records (ADRs)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Architecture Decision Records (ADRs)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR Master Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/ADR-000-template.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-000-template
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/ADR-0001-java-17-runtime/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java 17 Runtime
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/ADR-0002-r3-corda-5-dlt-platform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    R3 Corda 5 DLT Platform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/ADR-0003-docker-compose-phase1-orchestration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker Compose Phase 1 Orchestration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/ADR-0004-service-framework-defaults/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Service Framework Defaults
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Planning
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Planning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../planning/phase1-epics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Phase 1 Epics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../planning/delivery-plan-12weeks-tdd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Delivery Plan (12 Weeks)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Product
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Product
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../product/Phase1_PRD/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Phase 1 PRD
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    QA & Compliance
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            QA & Compliance
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/Phase1_Functional_Test_Cases/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Functional Test Cases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/Phase1_PRD_to_TestCase_Mapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PRD to Test Case Mapping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/phase1-functional-test-suite-tech-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Phase 1 Functional Test Suite - Technical Specification
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/local-cicd-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Local CI/CD Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/github-actions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitHub Actions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/cypress-e2e-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cypress E2E Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/functional-test-driven-development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Functional Test-Driven Development
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/authentication-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Authentication System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/security-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security Best Practices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/testing-strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Deployment
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Deployment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../production-deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Production Deployment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../authentication-deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Authentication Deployment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Cloud Infrastructure
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Cloud Infrastructure
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amazon-web-services-aws" class="md-nav__link">
    <span class="md-ellipsis">
      Amazon Web Services (AWS)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Amazon Web Services (AWS)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Infrastructure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Terraform Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-infrastructure-maintf" class="md-nav__link">
    <span class="md-ellipsis">
      Main Infrastructure (main.tf)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-rdstf" class="md-nav__link">
    <span class="md-ellipsis">
      Database (rds.tf)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ecs-cluster-ecstf" class="md-nav__link">
    <span class="md-ellipsis">
      ECS Cluster (ecs.tf)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-balancer-albtf" class="md-nav__link">
    <span class="md-ellipsis">
      Load Balancer (alb.tf)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s3-and-cloudfront-s3tf" class="md-nav__link">
    <span class="md-ellipsis">
      S3 and CloudFront (s3.tf)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#google-cloud-platform-gcp" class="md-nav__link">
    <span class="md-ellipsis">
      Google Cloud Platform (GCP)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Google Cloud Platform (GCP)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_1" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Terraform Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-infrastructure-maintf_1" class="md-nav__link">
    <span class="md-ellipsis">
      Main Infrastructure (main.tf)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gke-cluster-gketf" class="md-nav__link">
    <span class="md-ellipsis">
      GKE Cluster (gke.tf)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloud-sql-cloudsqltf" class="md-nav__link">
    <span class="md-ellipsis">
      Cloud SQL (cloudsql.tf)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-commands_1" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#microsoft-azure" class="md-nav__link">
    <span class="md-ellipsis">
      Microsoft Azure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Microsoft Azure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_2" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-configuration_1" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Terraform Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-infrastructure-maintf_2" class="md-nav__link">
    <span class="md-ellipsis">
      Main Infrastructure (main.tf)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aks-cluster-akstf" class="md-nav__link">
    <span class="md-ellipsis">
      AKS Cluster (aks.tf)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgresql-database-postgresqltf" class="md-nav__link">
    <span class="md-ellipsis">
      PostgreSQL Database (postgresql.tf)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#digital-ocean-simplified" class="md-nav__link">
    <span class="md-ellipsis">
      Digital Ocean (Simplified)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Digital Ocean (Simplified)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#terraform-configuration_2" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cicd-integration" class="md-nav__link">
    <span class="md-ellipsis">
      CI/CD Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CI/CD Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#github-actions-for-cloud-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      GitHub Actions for Cloud Deployment
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-observability" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Observability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring and Observability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloud-native-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Cloud-Native Monitoring
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-cloudwatch-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      Example CloudWatch Dashboard
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cost Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-cost-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      AWS Cost Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-cloud-cost-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Cloud Cost Comparison
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disaster-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Disaster Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Disaster Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-region-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Region Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backup-and-recovery-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      Backup and Recovery Procedures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Security Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-security" class="md-nav__link">
    <span class="md-ellipsis">
      Infrastructure Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-cloud-issues" class="md-nav__link">
    <span class="md-ellipsis">
      Common Cloud Issues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#related-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      Related Documentation
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../environment-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environment Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../observability-monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Observability & Monitoring
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../security-secrets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security & Secrets
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Technical Documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Technical Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tech/tech-landscape/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tech Landscape (MVP)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="cloud-infrastructure-setup-guide">Cloud Infrastructure Setup Guide<a class="headerlink" href="#cloud-infrastructure-setup-guide" title="Permanent link">&para;</a></h1>
<p>This guide provides comprehensive instructions for setting up cloud infrastructure for the DealSphere platform across major cloud providers.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The DealSphere platform can be deployed on multiple cloud providers with Infrastructure as Code (IaC) for consistent, reproducible deployments.</p>
<p><strong>Supported Cloud Providers:</strong>
- Amazon Web Services (AWS)
- Google Cloud Platform (GCP)
- Microsoft Azure
- Digital Ocean (simplified setup)</p>
<h2 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Load Balancer │────│  Frontend (CDN) │────│   Static Assets │
│   (ALB/CLB)     │    │    (Nginx)      │    │      (S3)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │
         │              ┌─────────────────┐
         │              │   Backend API   │
         │              │ (ECS/GKE/AKS)   │
         │              └─────────────────┘
         │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Monitoring    │    │    Database     │    │ Secrets Manager │
│ (Prometheus/    │    │ (RDS/CloudSQL/  │    │  (Vault/KMS/    │
│  Grafana)       │    │  Azure DB)      │    │   Key Vault)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
</code></pre></div>

<h2 id="amazon-web-services-aws">Amazon Web Services (AWS)<a class="headerlink" href="#amazon-web-services-aws" title="Permanent link">&para;</a></h2>
<h3 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h3>
<p><strong>Required AWS CLI and Tools:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Install AWS CLI</span>
curl<span class="w"> </span><span class="s2">&quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="s2">&quot;awscliv2.zip&quot;</span>
unzip<span class="w"> </span>awscliv2.zip
sudo<span class="w"> </span>./aws/install

<span class="c1"># Install Terraform</span>
wget<span class="w"> </span>https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
unzip<span class="w"> </span>terraform_1.6.0_linux_amd64.zip
sudo<span class="w"> </span>mv<span class="w"> </span>terraform<span class="w"> </span>/usr/local/bin/

<span class="c1"># Configure AWS credentials</span>
aws<span class="w"> </span>configure
</code></pre></div>

<h3 id="terraform-infrastructure">Terraform Infrastructure<a class="headerlink" href="#terraform-infrastructure" title="Permanent link">&para;</a></h3>
<h4 id="main-infrastructure-maintf">Main Infrastructure (main.tf)<a class="headerlink" href="#main-infrastructure-maintf" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">required_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;= 1.0&quot;</span>
<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">aws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/aws&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 5.0&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">backend</span><span class="w"> </span><span class="nv">&quot;s3&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-terraform-state&quot;</span>
<span class="w">    </span><span class="na">key</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production/terraform.tfstate&quot;</span>
<span class="w">    </span><span class="na">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;us-west-2&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;aws&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_region</span>

<span class="w">  </span><span class="nb">default_tags</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">Project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DealSphere&quot;</span>
<span class="w">      </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">      </span><span class="na">ManagedBy</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Terraform&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Variables</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;aws_region&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;AWS region&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;us-west-2&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;environment&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Environment (staging/production)&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;domain_name&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Domain name for the application&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="c1"># Data sources</span>
<span class="kr">data</span><span class="w"> </span><span class="nc">&quot;aws_availability_zones&quot;</span><span class="w"> </span><span class="nv">&quot;available&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;available&quot;</span>
<span class="p">}</span>

<span class="c1"># VPC and Networking</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_vpc&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">cidr_block</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.0.0.0/16&quot;</span>
<span class="w">  </span><span class="na">enable_dns_hostnames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">enable_dns_support</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-vpc&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_internet_gateway&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.main.id</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-igw&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_subnet&quot;</span><span class="w"> </span><span class="nv">&quot;public&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>

<span class="w">  </span><span class="na">vpc_id</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.main.id</span>
<span class="w">  </span><span class="na">cidr_block</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.0.${count.index + 1}.0/24&quot;</span>
<span class="w">  </span><span class="na">availability_zone</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_availability_zones.available.names[count.index</span><span class="p">]</span>
<span class="w">  </span><span class="na">map_public_ip_on_launch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-public-${count.index + 1}&quot;</span>
<span class="w">    </span><span class="na">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Public&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_subnet&quot;</span><span class="w"> </span><span class="nv">&quot;private&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>

<span class="w">  </span><span class="na">vpc_id</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.main.id</span>
<span class="w">  </span><span class="na">cidr_block</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.0.${count.index + 10}.0/24&quot;</span>
<span class="w">  </span><span class="na">availability_zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_availability_zones.available.names[count.index</span><span class="p">]</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-private-${count.index + 1}&quot;</span>
<span class="w">    </span><span class="na">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Private&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_route_table&quot;</span><span class="w"> </span><span class="nv">&quot;public&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.main.id</span>

<span class="w">  </span><span class="nb">route</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">cidr_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.0.0.0/0&quot;</span>
<span class="w">    </span><span class="na">gateway_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_internet_gateway.main.id</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-public-rt&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_route_table_association&quot;</span><span class="w"> </span><span class="nv">&quot;public&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">aws_subnet.public</span><span class="p">)</span>

<span class="w">  </span><span class="na">subnet_id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_subnet.public[count.index].id</span>
<span class="w">  </span><span class="na">route_table_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_route_table.public.id</span>
<span class="p">}</span>

<span class="c1"># NAT Gateway for private subnets</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_eip&quot;</span><span class="w"> </span><span class="nv">&quot;nat&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;vpc&quot;</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-nat-eip&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_nat_gateway&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">allocation_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_eip.nat.id</span>
<span class="w">  </span><span class="na">subnet_id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_subnet.public[0].id</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-nat-gw&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_route_table&quot;</span><span class="w"> </span><span class="nv">&quot;private&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.main.id</span>

<span class="w">  </span><span class="nb">route</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">cidr_block</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.0.0.0/0&quot;</span>
<span class="w">    </span><span class="na">nat_gateway_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_nat_gateway.main.id</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-private-rt&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_route_table_association&quot;</span><span class="w"> </span><span class="nv">&quot;private&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">aws_subnet.private</span><span class="p">)</span>

<span class="w">  </span><span class="na">subnet_id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_subnet.private[count.index].id</span>
<span class="w">  </span><span class="na">route_table_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_route_table.private.id</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="database-rdstf">Database (rds.tf)<a class="headerlink" href="#database-rdstf" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># RDS Subnet Group</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_db_subnet_group&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-db-subnet-group&quot;</span>
<span class="w">  </span><span class="na">subnet_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_subnet.private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">id</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-db-subnet-group&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Database Security Group</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_security_group&quot;</span><span class="w"> </span><span class="nv">&quot;database&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-db-&quot;</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.main.id</span>

<span class="w">  </span><span class="nb">ingress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">description</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PostgreSQL from application&quot;</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="m">5432</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="m">5432</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="na">security_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_security_group.backend.id</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">egress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;-1&quot;</span>
<span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-db-sg&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RDS Instance</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_db_instance&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">identifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-db&quot;</span>

<span class="w">  </span><span class="na">engine</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;postgres&quot;</span>
<span class="w">  </span><span class="na">engine_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;16.1&quot;</span>
<span class="w">  </span><span class="na">instance_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot; ? &quot;db.t3.medium&quot; : &quot;db.t3.micro&quot;</span>

<span class="w">  </span><span class="na">allocated_storage</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">20</span>
<span class="w">  </span><span class="na">max_allocated_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">100</span>
<span class="w">  </span><span class="na">storage_type</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;gp3&quot;</span>
<span class="w">  </span><span class="na">storage_encrypted</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="w">  </span><span class="na">db_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere&quot;</span>
<span class="w">  </span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere&quot;</span>
<span class="w">  </span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.db_password.result</span>

<span class="w">  </span><span class="na">vpc_security_group_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_security_group.database.id</span><span class="p">]</span>
<span class="w">  </span><span class="na">db_subnet_group_name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_db_subnet_group.main.name</span>

<span class="w">  </span><span class="na">backup_retention_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">7</span>
<span class="w">  </span><span class="na">backup_window</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;03:00-04:00&quot;</span>
<span class="w">  </span><span class="na">maintenance_window</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sun:04:00-sun:05:00&quot;</span>

<span class="w">  </span><span class="na">skip_final_snapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">!=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="w">  </span><span class="na">deletion_protection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>

<span class="w">  </span><span class="na">performance_insights_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">monitoring_interval</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="m">60</span>
<span class="w">  </span><span class="na">monitoring_role_arn</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.rds_monitoring.arn</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-db&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Random password for database</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_password&quot;</span><span class="w"> </span><span class="nv">&quot;db_password&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">length</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">32</span>
<span class="w">  </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="c1"># Store database password in Secrets Manager</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_secretsmanager_secret&quot;</span><span class="w"> </span><span class="nv">&quot;db_password&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere/${var.environment}/db-password&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_secretsmanager_secret_version&quot;</span><span class="w"> </span><span class="nv">&quot;db_password&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">secret_id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_secretsmanager_secret.db_password.id</span>
<span class="w">  </span><span class="na">secret_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.db_password.result</span>
<span class="p">}</span>

<span class="c1"># RDS Monitoring Role</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role&quot;</span><span class="w"> </span><span class="nv">&quot;rds_monitoring&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-rds-monitoring-role&quot;</span>

<span class="w">  </span><span class="na">assume_role_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span>
<span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="na">Action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sts:AssumeRole&quot;</span>
<span class="w">        </span><span class="na">Effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">        </span><span class="nb">Principal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="na">Service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;monitoring.rds.amazonaws.com&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role_policy_attachment&quot;</span><span class="w"> </span><span class="nv">&quot;rds_monitoring&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">role</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.rds_monitoring.name</span>
<span class="w">  </span><span class="na">policy_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="ecs-cluster-ecstf">ECS Cluster (ecs.tf)<a class="headerlink" href="#ecs-cluster-ecstf" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ECS Cluster</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_ecs_cluster&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}&quot;</span>

<span class="w">  </span><span class="nb">configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">execute_command_configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">logging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;OVERRIDE&quot;</span>
<span class="w">      </span><span class="nb">log_configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">cloud_watch_log_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_cloudwatch_log_group.ecs.name</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-cluster&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudWatch Log Group</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudwatch_log_group&quot;</span><span class="w"> </span><span class="nv">&quot;ecs&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/ecs/dealsphere-${var.environment}&quot;</span>
<span class="w">  </span><span class="na">retention_in_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">7</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-logs&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Backend Security Group</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_security_group&quot;</span><span class="w"> </span><span class="nv">&quot;backend&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-backend-&quot;</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.main.id</span>

<span class="w">  </span><span class="nb">ingress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">description</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTP from ALB&quot;</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="m">8080</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="m">8080</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="na">security_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_security_group.alb.id</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">egress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;-1&quot;</span>
<span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-backend-sg&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ECS Task Definition</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_ecs_task_definition&quot;</span><span class="w"> </span><span class="nv">&quot;backend&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">family</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-backend&quot;</span>
<span class="w">  </span><span class="na">network_mode</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;awsvpc&quot;</span>
<span class="w">  </span><span class="na">requires_compatibilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;FARGATE&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="na">cpu</span><span class="w">                      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">2048</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">1024</span>
<span class="w">  </span><span class="na">memory</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">4096</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">2048</span>
<span class="w">  </span><span class="na">execution_role_arn</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.ecs_execution.arn</span>
<span class="w">  </span><span class="na">task_role_arn</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.ecs_task.arn</span>

<span class="w">  </span><span class="na">container_definitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">([</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;backend&quot;</span>
<span class="w">      </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;your-account.dkr.ecr.${var.aws_region}.amazonaws.com/dealsphere-backend:latest&quot;</span>

<span class="w">      </span><span class="na">portMappings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="na">containerPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8080</span>
<span class="w">          </span><span class="na">protocol</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>

<span class="w">      </span><span class="na">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SPRING_PROFILES_ACTIVE&quot;</span>
<span class="w">          </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;POSTGRES_HOST&quot;</span>
<span class="w">          </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_db_instance.main.address</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;POSTGRES_DB&quot;</span>
<span class="w">          </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_db_instance.main.db_name</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;POSTGRES_USER&quot;</span>
<span class="w">          </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_db_instance.main.username</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>

<span class="w">      </span><span class="na">secrets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span>
<span class="w">          </span><span class="na">valueFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_secretsmanager_secret.db_password.arn</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>

<span class="w">      </span><span class="nb">logConfiguration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">logDriver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;awslogs&quot;</span>
<span class="w">        </span><span class="nb">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="na">awslogs-group</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_cloudwatch_log_group.ecs.name</span>
<span class="w">          </span><span class="na">awslogs-region</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_region</span>
<span class="w">          </span><span class="na">awslogs-stream-prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;backend&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nb">healthCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;CMD-SHELL&quot;, &quot;curl -f http://localhost:8080/actuator/health || exit 1&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="na">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span>
<span class="w">        </span><span class="na">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="w">        </span><span class="na">retries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="na">essential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">])</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-backend-task&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ECS Service</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_ecs_service&quot;</span><span class="w"> </span><span class="nv">&quot;backend&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-backend&quot;</span>
<span class="w">  </span><span class="na">cluster</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_ecs_cluster.main.id</span>
<span class="w">  </span><span class="na">task_definition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_ecs_task_definition.backend.arn</span>
<span class="w">  </span><span class="na">desired_count</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="na">launch_type</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;FARGATE&quot;</span>

<span class="w">  </span><span class="nb">network_configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">subnets</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_subnet.private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">id</span>
<span class="w">    </span><span class="na">security_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_security_group.backend.id</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">load_balancer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">target_group_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lb_target_group.backend.arn</span>
<span class="w">    </span><span class="na">container_name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;backend&quot;</span>
<span class="w">    </span><span class="na">container_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">8080</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_lb_listener.backend</span><span class="p">]</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-backend-service&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># IAM Roles for ECS</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role&quot;</span><span class="w"> </span><span class="nv">&quot;ecs_execution&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-ecs-execution-role&quot;</span>

<span class="w">  </span><span class="na">assume_role_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span>
<span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="na">Action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sts:AssumeRole&quot;</span>
<span class="w">        </span><span class="na">Effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">        </span><span class="nb">Principal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="na">Service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ecs-tasks.amazonaws.com&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role_policy_attachment&quot;</span><span class="w"> </span><span class="nv">&quot;ecs_execution&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">role</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.ecs_execution.name</span>
<span class="w">  </span><span class="na">policy_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role_policy&quot;</span><span class="w"> </span><span class="nv">&quot;ecs_secrets&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ecs-secrets-policy&quot;</span>
<span class="w">  </span><span class="na">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.ecs_execution.id</span>

<span class="w">  </span><span class="na">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span>
<span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="na">Effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">        </span><span class="na">Action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;secretsmanager:GetSecretValue&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">        </span><span class="na">Resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="nv">aws_secretsmanager_secret.db_password.arn</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role&quot;</span><span class="w"> </span><span class="nv">&quot;ecs_task&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-ecs-task-role&quot;</span>

<span class="w">  </span><span class="na">assume_role_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span>
<span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="na">Action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sts:AssumeRole&quot;</span>
<span class="w">        </span><span class="na">Effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">        </span><span class="nb">Principal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="na">Service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ecs-tasks.amazonaws.com&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="load-balancer-albtf">Load Balancer (alb.tf)<a class="headerlink" href="#load-balancer-albtf" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Application Load Balancer</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lb&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-alb&quot;</span>
<span class="w">  </span><span class="na">internal</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="na">load_balancer_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application&quot;</span>
<span class="w">  </span><span class="na">security_groups</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_security_group.alb.id</span><span class="p">]</span>
<span class="w">  </span><span class="na">subnets</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_subnet.public</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">id</span>

<span class="w">  </span><span class="na">enable_deletion_protection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-alb&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ALB Security Group</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_security_group&quot;</span><span class="w"> </span><span class="nv">&quot;alb&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-alb-&quot;</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.main.id</span>

<span class="w">  </span><span class="nb">ingress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTP&quot;</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">ingress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTPS&quot;</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">443</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">443</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">egress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;-1&quot;</span>
<span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-alb-sg&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Target Groups</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lb_target_group&quot;</span><span class="w"> </span><span class="nv">&quot;backend&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-backend-tg&quot;</span>
<span class="w">  </span><span class="na">port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">8080</span>
<span class="w">  </span><span class="na">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTP&quot;</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.main.id</span>
<span class="w">  </span><span class="na">target_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ip&quot;</span>

<span class="w">  </span><span class="nb">health_check</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">enabled</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="na">healthy_threshold</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<span class="w">    </span><span class="na">interval</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="m">30</span>
<span class="w">    </span><span class="na">matcher</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;200&quot;</span>
<span class="w">    </span><span class="na">path</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/actuator/health&quot;</span>
<span class="w">    </span><span class="na">port</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;traffic-port&quot;</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTP&quot;</span>
<span class="w">    </span><span class="na">timeout</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="w">    </span><span class="na">unhealthy_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-backend-tg&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># SSL Certificate</span>
<span class="kr">data</span><span class="w"> </span><span class="nc">&quot;aws_acm_certificate&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">domain</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.domain_name</span>
<span class="w">  </span><span class="na">statuses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ISSUED&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># ALB Listeners</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lb_listener&quot;</span><span class="w"> </span><span class="nv">&quot;redirect_http&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">load_balancer_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lb.main.arn</span>
<span class="w">  </span><span class="na">port</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;80&quot;</span>
<span class="w">  </span><span class="na">protocol</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTP&quot;</span>

<span class="w">  </span><span class="nb">default_action</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;redirect&quot;</span>

<span class="w">    </span><span class="nb">redirect</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">port</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;443&quot;</span>
<span class="w">      </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTPS&quot;</span>
<span class="w">      </span><span class="na">status_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTP_301&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lb_listener&quot;</span><span class="w"> </span><span class="nv">&quot;backend&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">load_balancer_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lb.main.arn</span>
<span class="w">  </span><span class="na">port</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;443&quot;</span>
<span class="w">  </span><span class="na">protocol</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTPS&quot;</span>
<span class="w">  </span><span class="na">ssl_policy</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ELBSecurityPolicy-TLS-1-2-2017-01&quot;</span>
<span class="w">  </span><span class="na">certificate_arn</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_acm_certificate.main.arn</span>

<span class="w">  </span><span class="nb">default_action</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">type</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;forward&quot;</span>
<span class="w">    </span><span class="na">target_group_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lb_target_group.backend.arn</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="s3-and-cloudfront-s3tf">S3 and CloudFront (s3.tf)<a class="headerlink" href="#s3-and-cloudfront-s3tf" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># S3 Bucket for Frontend</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket&quot;</span><span class="w"> </span><span class="nv">&quot;frontend&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-frontend-${random_id.bucket_suffix.hex}&quot;</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-frontend&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_id&quot;</span><span class="w"> </span><span class="nv">&quot;bucket_suffix&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">byte_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket_public_access_block&quot;</span><span class="w"> </span><span class="nv">&quot;frontend&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.frontend.id</span>

<span class="w">  </span><span class="na">block_public_acls</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">block_public_policy</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">ignore_public_acls</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">restrict_public_buckets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket_versioning&quot;</span><span class="w"> </span><span class="nv">&quot;frontend&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.frontend.id</span>
<span class="w">  </span><span class="nb">versioning_configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enabled&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudFront Distribution</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudfront_origin_access_control&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-oac&quot;</span>
<span class="w">  </span><span class="na">origin_access_control_origin_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;s3&quot;</span>
<span class="w">  </span><span class="na">signing_behavior</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;always&quot;</span>
<span class="w">  </span><span class="na">signing_protocol</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sigv4&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudfront_distribution&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">origin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">domain_name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.frontend.bucket_regional_domain_name</span>
<span class="w">    </span><span class="na">origin_id</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S3-${aws_s3_bucket.frontend.bucket}&quot;</span>
<span class="w">    </span><span class="na">origin_access_control_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_cloudfront_origin_access_control.main.id</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">origin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">domain_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lb.main.dns_name</span>
<span class="w">    </span><span class="na">origin_id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ALB-backend&quot;</span>

<span class="w">    </span><span class="nb">custom_origin_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">http_port</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<span class="w">      </span><span class="na">https_port</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">443</span>
<span class="w">      </span><span class="na">origin_protocol_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https-only&quot;</span>
<span class="w">      </span><span class="na">origin_ssl_protocols</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;TLSv1.2&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">enabled</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">is_ipv6_enabled</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">default_root_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;index.html&quot;</span>
<span class="w">  </span><span class="na">aliases</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">var.domain_name</span><span class="p">]</span>

<span class="w">  </span><span class="nb">default_cache_behavior</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">allowed_methods</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;DELETE&quot;, &quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;, &quot;PATCH&quot;, &quot;POST&quot;, &quot;PUT&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">cached_methods</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;GET&quot;, &quot;HEAD&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">target_origin_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S3-${aws_s3_bucket.frontend.bucket}&quot;</span>

<span class="w">    </span><span class="nb">forwarded_values</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">query_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">      </span><span class="nb">cookies</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;none&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">viewer_protocol_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;redirect-to-https&quot;</span>
<span class="w">    </span><span class="na">min_ttl</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">default_ttl</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="m">3600</span>
<span class="w">    </span><span class="na">max_ttl</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="m">86400</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">ordered_cache_behavior</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">path_pattern</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/api/*&quot;</span>
<span class="w">    </span><span class="na">allowed_methods</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;DELETE&quot;, &quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;, &quot;PATCH&quot;, &quot;POST&quot;, &quot;PUT&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">cached_methods</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;GET&quot;, &quot;HEAD&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">target_origin_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ALB-backend&quot;</span>

<span class="w">    </span><span class="nb">forwarded_values</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">query_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">      </span><span class="na">headers</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
<span class="w">      </span><span class="nb">cookies</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;all&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">viewer_protocol_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https-only&quot;</span>
<span class="w">    </span><span class="na">min_ttl</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">default_ttl</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">max_ttl</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">restrictions</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">geo_restriction</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">restriction_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;none&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">viewer_certificate</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">acm_certificate_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_acm_certificate.main.arn</span>
<span class="w">    </span><span class="na">ssl_support_method</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sni-only&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-cloudfront&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># S3 bucket policy for CloudFront</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket_policy&quot;</span><span class="w"> </span><span class="nv">&quot;frontend&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.frontend.id</span>

<span class="w">  </span><span class="na">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span>
<span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="na">Effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">        </span><span class="nb">Principal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="na">Service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cloudfront.amazonaws.com&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="na">Action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;s3:GetObject&quot;</span>
<span class="w">        </span><span class="na">Resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${aws_s3_bucket.frontend.arn}/*&quot;</span>
<span class="w">        </span><span class="nb">Condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nb">StringEquals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;AWS:SourceArn&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_cloudfront_distribution.main.arn</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="deployment-commands">Deployment Commands<a class="headerlink" href="#deployment-commands" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Initialize Terraform</span>
terraform<span class="w"> </span>init

<span class="c1"># Plan deployment</span>
terraform<span class="w"> </span>plan<span class="w"> </span>-var<span class="o">=</span><span class="s2">&quot;domain_name=yourdomain.com&quot;</span>

<span class="c1"># Apply infrastructure</span>
terraform<span class="w"> </span>apply<span class="w"> </span>-var<span class="o">=</span><span class="s2">&quot;domain_name=yourdomain.com&quot;</span>

<span class="c1"># Get outputs</span>
terraform<span class="w"> </span>output
</code></pre></div>

<h2 id="google-cloud-platform-gcp">Google Cloud Platform (GCP)<a class="headerlink" href="#google-cloud-platform-gcp" title="Permanent link">&para;</a></h2>
<h3 id="prerequisites_1">Prerequisites<a class="headerlink" href="#prerequisites_1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Install Google Cloud SDK</span>
curl<span class="w"> </span>https://sdk.cloud.google.com<span class="w"> </span><span class="p">|</span><span class="w"> </span>bash
<span class="nb">exec</span><span class="w"> </span>-l<span class="w"> </span><span class="nv">$SHELL</span>

<span class="c1"># Install Terraform</span>
<span class="c1"># (Same as AWS section above)</span>

<span class="c1"># Initialize and authenticate</span>
gcloud<span class="w"> </span>init
gcloud<span class="w"> </span>auth<span class="w"> </span>application-default<span class="w"> </span>login
</code></pre></div>

<h3 id="terraform-configuration">Terraform Configuration<a class="headerlink" href="#terraform-configuration" title="Permanent link">&para;</a></h3>
<h4 id="main-infrastructure-maintf_1">Main Infrastructure (main.tf)<a class="headerlink" href="#main-infrastructure-maintf_1" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">required_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;= 1.0&quot;</span>
<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">google</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/google&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 5.0&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">backend</span><span class="w"> </span><span class="nv">&quot;gcs&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-terraform-state&quot;</span>
<span class="w">    </span><span class="na">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;google&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">region</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">zone</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.zone</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;project_id&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GCP Project ID&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;region&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GCP region&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;us-central1&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;zone&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GCP zone&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;us-central1-a&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;environment&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Environment (staging/production)&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="p">}</span>

<span class="c1"># VPC Network</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_compute_network&quot;</span><span class="w"> </span><span class="nv">&quot;vpc&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-vpc&quot;</span>
<span class="w">  </span><span class="na">auto_create_subnetworks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_compute_subnetwork&quot;</span><span class="w"> </span><span class="nv">&quot;public&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-public&quot;</span>
<span class="w">  </span><span class="na">ip_cidr_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.0.1.0/24&quot;</span>
<span class="w">  </span><span class="na">region</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">network</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_network.vpc.id</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_compute_subnetwork&quot;</span><span class="w"> </span><span class="nv">&quot;private&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-private&quot;</span>
<span class="w">  </span><span class="na">ip_cidr_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.0.2.0/24&quot;</span>
<span class="w">  </span><span class="na">region</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">network</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_network.vpc.id</span>

<span class="w">  </span><span class="na">private_ip_google_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="c1"># Firewall Rules</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_compute_firewall&quot;</span><span class="w"> </span><span class="nv">&quot;allow_http_https&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-allow-http-https&quot;</span>
<span class="w">  </span><span class="na">network</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_network.vpc.name</span>

<span class="w">  </span><span class="nb">allow</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="na">ports</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;80&quot;, &quot;443&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">source_ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="na">target_tags</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;web-server&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_compute_firewall&quot;</span><span class="w"> </span><span class="nv">&quot;allow_internal&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-allow-internal&quot;</span>
<span class="w">  </span><span class="na">network</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_network.vpc.name</span>

<span class="w">  </span><span class="nb">allow</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="na">ports</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0-65535&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">allow</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;udp&quot;</span>
<span class="w">    </span><span class="na">ports</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0-65535&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">source_ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;10.0.0.0/8&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="gke-cluster-gketf">GKE Cluster (gke.tf)<a class="headerlink" href="#gke-cluster-gketf" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># GKE Cluster</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_container_cluster&quot;</span><span class="w"> </span><span class="nv">&quot;primary&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-gke&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>

<span class="w">  </span><span class="na">remove_default_node_pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">initial_node_count</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>

<span class="w">  </span><span class="na">network</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_network.vpc.name</span>
<span class="w">  </span><span class="na">subnetwork</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_subnetwork.private.name</span>

<span class="w">  </span><span class="nb">ip_allocation_policy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">cluster_ipv4_cidr_block</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.1.0.0/16&quot;</span>
<span class="w">    </span><span class="na">services_ipv4_cidr_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.2.0.0/16&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">private_cluster_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">enable_private_nodes</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="na">enable_private_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="na">master_ipv4_cidr_block</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;172.16.0.0/28&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">workload_identity_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">workload_pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.project_id}.svc.id.goog&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">addons_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">http_load_balancing</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nb">horizontal_pod_autoscaling</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">deletion_protection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="p">}</span>

<span class="c1"># Node Pool</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_container_node_pool&quot;</span><span class="w"> </span><span class="nv">&quot;primary_nodes&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-nodes&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="w">  </span><span class="na">cluster</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">google_container_cluster.primary.name</span>
<span class="w">  </span><span class="na">node_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">1</span>

<span class="w">  </span><span class="nb">node_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">preemptible</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">!=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="w">    </span><span class="na">machine_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot; ? &quot;e2-standard-4&quot; : &quot;e2-standard-2&quot;</span>

<span class="w">    </span><span class="na">service_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.gke_nodes.email</span>
<span class="w">    </span><span class="na">oauth_scopes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;https://www.googleapis.com/auth/cloud-platform&quot;</span>
<span class="w">    </span><span class="p">]</span>

<span class="w">    </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;gke-node&quot;, &quot;dealsphere-${var.environment}&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">autoscaling</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">min_node_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="na">max_node_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">3</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">management</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">auto_repair</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="na">auto_upgrade</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Service Account for GKE Nodes</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_service_account&quot;</span><span class="w"> </span><span class="nv">&quot;gke_nodes&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">account_id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-gke-nodes&quot;</span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GKE Nodes Service Account&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_project_iam_member&quot;</span><span class="w"> </span><span class="nv">&quot;gke_nodes&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">toset</span><span class="p">([</span>
<span class="w">    </span><span class="s2">&quot;roles/logging.logWriter&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;roles/monitoring.metricWriter&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;roles/monitoring.viewer&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;roles/stackdriver.resourceMetadata.writer&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;roles/storage.objectViewer&quot;</span>
<span class="w">  </span><span class="p">])</span>

<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.project_id</span>
<span class="w">  </span><span class="na">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span>
<span class="w">  </span><span class="na">member</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;serviceAccount:${google_service_account.gke_nodes.email}&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="cloud-sql-cloudsqltf">Cloud SQL (cloudsql.tf)<a class="headerlink" href="#cloud-sql-cloudsqltf" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Random password for database</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_password&quot;</span><span class="w"> </span><span class="nv">&quot;db_password&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">length</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">32</span>
<span class="w">  </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="c1"># Cloud SQL Instance</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_sql_database_instance&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-db&quot;</span>
<span class="w">  </span><span class="na">database_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;POSTGRES_16&quot;</span>
<span class="w">  </span><span class="na">region</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>

<span class="w">  </span><span class="nb">settings</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">tier</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot; ? &quot;db-standard-2&quot; : &quot;db-f1-micro&quot;</span>
<span class="w">    </span><span class="na">availability_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot; ? &quot;REGIONAL&quot; : &quot;ZONAL&quot;</span>
<span class="w">    </span><span class="na">disk_type</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PD_SSD&quot;</span>
<span class="w">    </span><span class="na">disk_size</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">20</span>
<span class="w">    </span><span class="na">disk_autoresize</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="w">    </span><span class="nb">backup_configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">enabled</span><span class="w">                        </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">      </span><span class="na">start_time</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;03:00&quot;</span>
<span class="w">      </span><span class="na">point_in_time_recovery_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="w">      </span><span class="nb">backup_retention_settings</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">retained_backups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">7</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">ip_configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">ipv4_enabled</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">      </span><span class="na">private_network</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_network.vpc.id</span>
<span class="w">      </span><span class="na">require_ssl</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">maintenance_window</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">day</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>
<span class="w">      </span><span class="na">hour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">insights_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">query_insights_enabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">      </span><span class="na">query_string_length</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">1024</span>
<span class="w">      </span><span class="na">record_application_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">      </span><span class="na">record_client_address</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">deletion_protection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="p">}</span>

<span class="c1"># Database</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_sql_database&quot;</span><span class="w"> </span><span class="nv">&quot;database&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere&quot;</span>
<span class="w">  </span><span class="na">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_sql_database_instance.main.name</span>
<span class="p">}</span>

<span class="c1"># Database User</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_sql_user&quot;</span><span class="w"> </span><span class="nv">&quot;user&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere&quot;</span>
<span class="w">  </span><span class="na">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_sql_database_instance.main.name</span>
<span class="w">  </span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.db_password.result</span>
<span class="p">}</span>

<span class="c1"># Private Service Access</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_compute_global_address&quot;</span><span class="w"> </span><span class="nv">&quot;private_ip_address&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-private-ip&quot;</span>
<span class="w">  </span><span class="na">purpose</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;VPC_PEERING&quot;</span>
<span class="w">  </span><span class="na">address_type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INTERNAL&quot;</span>
<span class="w">  </span><span class="na">prefix_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="na">network</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_network.vpc.id</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_service_networking_connection&quot;</span><span class="w"> </span><span class="nv">&quot;private_vpc_connection&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">network</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_network.vpc.id</span>
<span class="w">  </span><span class="na">service</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;servicenetworking.googleapis.com&quot;</span>
<span class="w">  </span><span class="na">reserved_peering_ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">google_compute_global_address.private_ip_address.name</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Secret Manager for database credentials</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_secret_manager_secret&quot;</span><span class="w"> </span><span class="nv">&quot;db_password&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">secret_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-db-password&quot;</span>

<span class="w">  </span><span class="nb">replication</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">automatic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;google_secret_manager_secret_version&quot;</span><span class="w"> </span><span class="nv">&quot;db_password&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">secret</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">google_secret_manager_secret.db_password.id</span>
<span class="w">  </span><span class="na">secret_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.db_password.result</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="deployment-commands_1">Deployment Commands<a class="headerlink" href="#deployment-commands_1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Set project</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">GOOGLE_PROJECT</span><span class="o">=</span>your-project-id

<span class="c1"># Initialize Terraform</span>
terraform<span class="w"> </span>init

<span class="c1"># Plan deployment</span>
terraform<span class="w"> </span>plan<span class="w"> </span>-var<span class="o">=</span><span class="s2">&quot;project_id=</span><span class="si">${</span><span class="nv">GOOGLE_PROJECT</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Apply infrastructure</span>
terraform<span class="w"> </span>apply<span class="w"> </span>-var<span class="o">=</span><span class="s2">&quot;project_id=</span><span class="si">${</span><span class="nv">GOOGLE_PROJECT</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Configure kubectl</span>
gcloud<span class="w"> </span>container<span class="w"> </span>clusters<span class="w"> </span>get-credentials<span class="w"> </span>dealsphere-production-gke<span class="w"> </span>--region<span class="w"> </span>us-central1

<span class="c1"># Deploy application</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>k8s/
</code></pre></div>

<h2 id="microsoft-azure">Microsoft Azure<a class="headerlink" href="#microsoft-azure" title="Permanent link">&para;</a></h2>
<h3 id="prerequisites_2">Prerequisites<a class="headerlink" href="#prerequisites_2" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Install Azure CLI</span>
curl<span class="w"> </span>-sL<span class="w"> </span>https://aka.ms/InstallAzureCLIDeb<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>bash

<span class="c1"># Login to Azure</span>
az<span class="w"> </span>login

<span class="c1"># Set subscription</span>
az<span class="w"> </span>account<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--subscription<span class="w"> </span><span class="s2">&quot;your-subscription-id&quot;</span>
</code></pre></div>

<h3 id="terraform-configuration_1">Terraform Configuration<a class="headerlink" href="#terraform-configuration_1" title="Permanent link">&para;</a></h3>
<h4 id="main-infrastructure-maintf_2">Main Infrastructure (main.tf)<a class="headerlink" href="#main-infrastructure-maintf_2" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">azurerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/azurerm&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 3.0&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">backend</span><span class="w"> </span><span class="nv">&quot;azurerm&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">resource_group_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;terraform-state-rg&quot;</span>
<span class="w">    </span><span class="na">storage_account_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealspherestate&quot;</span>
<span class="w">    </span><span class="na">container_name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tfstate&quot;</span>
<span class="w">    </span><span class="na">key</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production.terraform.tfstate&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;azurerm&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">features</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;location&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Azure region&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;East US&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;environment&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Environment (staging/production)&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="p">}</span>

<span class="c1"># Resource Group</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_resource_group&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-rg&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.location</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">    </span><span class="na">Project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DealSphere&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Virtual Network</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_virtual_network&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-vnet&quot;</span>
<span class="w">  </span><span class="na">address_space</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;10.0.0.0/16&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_subnet&quot;</span><span class="w"> </span><span class="nv">&quot;public&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;public&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">virtual_network_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_virtual_network.main.name</span>
<span class="w">  </span><span class="na">address_prefixes</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;10.0.1.0/24&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_subnet&quot;</span><span class="w"> </span><span class="nv">&quot;private&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;private&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">virtual_network_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_virtual_network.main.name</span>
<span class="w">  </span><span class="na">address_prefixes</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;10.0.2.0/24&quot;</span><span class="p">]</span>

<span class="w">  </span><span class="na">service_endpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Microsoft.Sql&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Network Security Groups</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_network_security_group&quot;</span><span class="w"> </span><span class="nv">&quot;public&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-public-nsg&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>

<span class="w">  </span><span class="nb">security_rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTP&quot;</span>
<span class="w">    </span><span class="na">priority</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="m">1001</span>
<span class="w">    </span><span class="na">direction</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Inbound&quot;</span>
<span class="w">    </span><span class="na">access</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Tcp&quot;</span>
<span class="w">    </span><span class="na">source_port_range</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">    </span><span class="na">destination_port_range</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;80&quot;</span>
<span class="w">    </span><span class="na">source_address_prefix</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">    </span><span class="na">destination_address_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">security_rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTPS&quot;</span>
<span class="w">    </span><span class="na">priority</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="m">1002</span>
<span class="w">    </span><span class="na">direction</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Inbound&quot;</span>
<span class="w">    </span><span class="na">access</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Tcp&quot;</span>
<span class="w">    </span><span class="na">source_port_range</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">    </span><span class="na">destination_port_range</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;443&quot;</span>
<span class="w">    </span><span class="na">source_address_prefix</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">    </span><span class="na">destination_address_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_subnet_network_security_group_association&quot;</span><span class="w"> </span><span class="nv">&quot;public&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">subnet_id</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_subnet.public.id</span>
<span class="w">  </span><span class="na">network_security_group_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_network_security_group.public.id</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="aks-cluster-akstf">AKS Cluster (aks.tf)<a class="headerlink" href="#aks-cluster-akstf" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># AKS Cluster</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_kubernetes_cluster&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-aks&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">dns_prefix</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}&quot;</span>

<span class="w">  </span><span class="nb">default_node_pool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;default&quot;</span>
<span class="w">    </span><span class="na">node_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="na">vm_size</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot; ? &quot;Standard_D4s_v3&quot; : &quot;Standard_B2s&quot;</span>

<span class="w">    </span><span class="na">vnet_subnet_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_subnet.private.id</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">identity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SystemAssigned&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">network_profile</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">network_plugin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;azure&quot;</span>
<span class="w">    </span><span class="na">service_cidr</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.1.0.0/16&quot;</span>
<span class="w">    </span><span class="na">dns_service_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.1.0.10&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Additional Node Pool for Production</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_kubernetes_cluster_node_pool&quot;</span><span class="w"> </span><span class="nv">&quot;production&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">name</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="w">  </span><span class="na">kubernetes_cluster_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_kubernetes_cluster.main.id</span>
<span class="w">  </span><span class="na">vm_size</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Standard_D8s_v3&quot;</span>
<span class="w">  </span><span class="na">node_count</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<span class="w">  </span><span class="na">vnet_subnet_id</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_subnet.private.id</span>

<span class="w">  </span><span class="na">node_taints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;workload=production:NoSchedule&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="nb">node_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;workload&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="postgresql-database-postgresqltf">PostgreSQL Database (postgresql.tf)<a class="headerlink" href="#postgresql-database-postgresqltf" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Random password for database</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_password&quot;</span><span class="w"> </span><span class="nv">&quot;db_password&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">length</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">32</span>
<span class="w">  </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="c1"># PostgreSQL Server</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_postgresql_flexible_server&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-psql&quot;</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">location</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>
<span class="w">  </span><span class="na">version</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;16&quot;</span>

<span class="w">  </span><span class="na">administrator_login</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere&quot;</span>
<span class="w">  </span><span class="na">administrator_password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.db_password.result</span>

<span class="w">  </span><span class="na">storage_mb</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">102400</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">32768</span>
<span class="w">  </span><span class="na">storage_tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;P4&quot;</span>

<span class="w">  </span><span class="na">sku_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot; ? &quot;GP_Standard_D4s_v3&quot; : &quot;B_Standard_B1ms&quot;</span>
<span class="w">  </span><span class="na">zone</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1&quot;</span>

<span class="w">  </span><span class="na">backup_retention_days</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">35</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">7</span>
<span class="w">  </span><span class="na">point_in_time_restore_time_in_minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">10080</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">60</span>

<span class="w">  </span><span class="nb">high_availability</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot; ? &quot;ZoneRedundant&quot; : &quot;Disabled&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># PostgreSQL Database</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_postgresql_flexible_server_database&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere&quot;</span>
<span class="w">  </span><span class="na">server_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_postgresql_flexible_server.main.id</span>
<span class="w">  </span><span class="na">collation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;en_US.UTF8&quot;</span>
<span class="w">  </span><span class="na">charset</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;UTF8&quot;</span>
<span class="p">}</span>

<span class="c1"># Firewall rule for AKS subnet</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_postgresql_flexible_server_firewall_rule&quot;</span><span class="w"> </span><span class="nv">&quot;aks&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;aks-subnet&quot;</span>
<span class="w">  </span><span class="na">server_id</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_postgresql_flexible_server.main.id</span>
<span class="w">  </span><span class="na">start_ip_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cidrhost</span><span class="p">(</span><span class="nv">azurerm_subnet.private.address_prefixes[0</span><span class="p">],</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="w">  </span><span class="na">end_ip_address</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nf">cidrhost</span><span class="p">(</span><span class="nv">azurerm_subnet.private.address_prefixes[0</span><span class="p">],</span><span class="w"> </span><span class="err">-</span><span class="m">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Key Vault for secrets</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_key_vault&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-kv-${random_id.kv_suffix.hex}&quot;</span>
<span class="w">  </span><span class="na">location</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.location</span>
<span class="w">  </span><span class="na">resource_group_name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_resource_group.main.name</span>
<span class="w">  </span><span class="na">tenant_id</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_client_config.current.tenant_id</span>
<span class="w">  </span><span class="na">sku_name</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;standard&quot;</span>
<span class="w">  </span><span class="na">soft_delete_retention_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>

<span class="w">  </span><span class="nb">access_policy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_client_config.current.tenant_id</span>
<span class="w">    </span><span class="na">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_client_config.current.object_id</span>

<span class="w">    </span><span class="na">secret_permissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;Get&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;List&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Set&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Delete&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Recover&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Backup&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Restore&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_id&quot;</span><span class="w"> </span><span class="nv">&quot;kv_suffix&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">byte_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<span class="p">}</span>

<span class="kr">data</span><span class="w"> </span><span class="nc">&quot;azurerm_client_config&quot;</span><span class="w"> </span><span class="nv">&quot;current&quot;</span><span class="w"> </span><span class="p">{}</span>

<span class="c1"># Store database password in Key Vault</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_key_vault_secret&quot;</span><span class="w"> </span><span class="nv">&quot;db_password&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;db-password&quot;</span>
<span class="w">  </span><span class="na">value</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.db_password.result</span>
<span class="w">  </span><span class="na">key_vault_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_key_vault.main.id</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="digital-ocean-simplified">Digital Ocean (Simplified)<a class="headerlink" href="#digital-ocean-simplified" title="Permanent link">&para;</a></h2>
<h3 id="terraform-configuration_2">Terraform Configuration<a class="headerlink" href="#terraform-configuration_2" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">digitalocean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;digitalocean/digitalocean&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 2.0&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;digitalocean&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.do_token</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;do_token&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DigitalOcean API Token&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">sensitive</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="c1"># VPC</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;digitalocean_vpc&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-vpc&quot;</span>
<span class="w">  </span><span class="na">region</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nyc3&quot;</span>
<span class="w">  </span><span class="na">ip_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.10.0.0/16&quot;</span>
<span class="p">}</span>

<span class="c1"># Kubernetes Cluster</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;digitalocean_kubernetes_cluster&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}&quot;</span>
<span class="w">  </span><span class="na">region</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nyc3&quot;</span>
<span class="w">  </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.28.2-do.0&quot;</span>
<span class="w">  </span><span class="na">vpc_uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">digitalocean_vpc.main.id</span>

<span class="w">  </span><span class="nb">node_pool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;worker-pool&quot;</span>
<span class="w">    </span><span class="na">size</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot; ? &quot;s-4vcpu-8gb&quot; : &quot;s-2vcpu-4gb&quot;</span>
<span class="w">    </span><span class="na">node_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">2</span>
<span class="w">    </span><span class="na">auto_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="na">min_nodes</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="na">max_nodes</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">5</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;dealsphere&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">var.environment</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Database</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;digitalocean_database_cluster&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-db&quot;</span>
<span class="w">  </span><span class="na">engine</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;pg&quot;</span>
<span class="w">  </span><span class="na">version</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;16&quot;</span>
<span class="w">  </span><span class="na">size</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot; ? &quot;db-s-4vcpu-8gb&quot; : &quot;db-s-1vcpu-2gb&quot;</span>
<span class="w">  </span><span class="na">region</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nyc3&quot;</span>
<span class="w">  </span><span class="na">node_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">1</span>

<span class="w">  </span><span class="na">private_network_uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">digitalocean_vpc.main.id</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;dealsphere&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">var.environment</span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;digitalocean_database_db&quot;</span><span class="w"> </span><span class="nv">&quot;dealsphere&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">cluster_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">digitalocean_database_cluster.main.id</span>
<span class="w">  </span><span class="na">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;digitalocean_database_user&quot;</span><span class="w"> </span><span class="nv">&quot;dealsphere&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">cluster_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">digitalocean_database_cluster.main.id</span>
<span class="w">  </span><span class="na">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere&quot;</span>
<span class="p">}</span>

<span class="c1"># Load Balancer</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;digitalocean_loadbalancer&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-lb&quot;</span>
<span class="w">  </span><span class="na">region</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nyc3&quot;</span>
<span class="w">  </span><span class="na">vpc_uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">digitalocean_vpc.main.id</span>

<span class="w">  </span><span class="nb">forwarding_rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">entry_protocol</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http&quot;</span>
<span class="w">    </span><span class="na">entry_port</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<span class="w">    </span><span class="na">target_protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http&quot;</span>
<span class="w">    </span><span class="na">target_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<span class="w">    </span><span class="na">redirect_http_to_https</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">forwarding_rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">entry_protocol</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https&quot;</span>
<span class="w">    </span><span class="na">entry_port</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">443</span>
<span class="w">    </span><span class="na">target_protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http&quot;</span>
<span class="w">    </span><span class="na">target_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<span class="w">    </span><span class="na">certificate_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">digitalocean_certificate.main.name</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">healthcheck</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http&quot;</span>
<span class="w">    </span><span class="na">port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<span class="w">    </span><span class="na">path</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/health&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;dealsphere&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">var.environment</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># SSL Certificate</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;digitalocean_certificate&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere-${var.environment}-cert&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lets_encrypt&quot;</span>
<span class="w">  </span><span class="na">domains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">var.domain_name</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Container Registry</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;digitalocean_container_registry&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dealsphere&quot;</span>
<span class="w">  </span><span class="na">subscription_tier_slug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;basic&quot;</span>
<span class="w">  </span><span class="na">region</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nyc3&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="cicd-integration">CI/CD Integration<a class="headerlink" href="#cicd-integration" title="Permanent link">&para;</a></h2>
<h3 id="github-actions-for-cloud-deployment">GitHub Actions for Cloud Deployment<a class="headerlink" href="#github-actions-for-cloud-deployment" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/deploy-cloud.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy to Cloud</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">workflow_dispatch</span><span class="p">:</span>
<span class="w">    </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Environment</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">deploy&#39;</span>
<span class="w">        </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;staging&#39;</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">choice</span>
<span class="w">        </span><span class="nt">options</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">staging</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>

<span class="nt">env</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ENVIRONMENT</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ github.event.inputs.environment || &#39;staging&#39; }}</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">deploy-infrastructure</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy Infrastructure</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup Terraform</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hashicorp/setup-terraform@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">terraform_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.6.0</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure AWS credentials</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-actions/configure-aws-credentials@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">aws-access-key-id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.AWS_ACCESS_KEY_ID }}</span>
<span class="w">          </span><span class="nt">aws-secret-access-key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.AWS_SECRET_ACCESS_KEY }}</span>
<span class="w">          </span><span class="nt">aws-region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Terraform Init</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">terraform init</span>
<span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./infrastructure/aws</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Terraform Plan</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">terraform plan -var=&quot;environment=${{ env.ENVIRONMENT }}&quot;</span>
<span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./infrastructure/aws</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Terraform Apply</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.ref == &#39;refs/heads/main&#39;</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">terraform apply -auto-approve -var=&quot;environment=${{ env.ENVIRONMENT }}&quot;</span>
<span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./infrastructure/aws</span>

<span class="w">  </span><span class="nt">deploy-application</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy Application</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">deploy-infrastructure</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure AWS credentials</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-actions/configure-aws-credentials@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">aws-access-key-id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.AWS_ACCESS_KEY_ID }}</span>
<span class="w">          </span><span class="nt">aws-secret-access-key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.AWS_SECRET_ACCESS_KEY }}</span>
<span class="w">          </span><span class="nt">aws-region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Login to Amazon ECR</span>
<span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">login-ecr</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-actions/amazon-ecr-login@v2</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build and push Docker images</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no"># Backend</span>
<span class="w">          </span><span class="no">docker build -t $ECR_REGISTRY/dealsphere-backend:${{ github.sha }} ./backend</span>
<span class="w">          </span><span class="no">docker push $ECR_REGISTRY/dealsphere-backend:${{ github.sha }}</span>

<span class="w">          </span><span class="no"># Frontend</span>
<span class="w">          </span><span class="no">docker build -t $ECR_REGISTRY/dealsphere-frontend:${{ github.sha }} ./frontend</span>
<span class="w">          </span><span class="no">docker push $ECR_REGISTRY/dealsphere-frontend:${{ github.sha }}</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ECR_REGISTRY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ steps.login-ecr.outputs.registry }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy to ECS</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no"># Update task definition with new image</span>
<span class="w">          </span><span class="no">aws ecs update-service \</span>
<span class="w">            </span><span class="no">--cluster dealsphere-${{ env.ENVIRONMENT }} \</span>
<span class="w">            </span><span class="no">--service dealsphere-backend \</span>
<span class="w">            </span><span class="no">--force-new-deployment</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Wait for deployment</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">aws ecs wait services-stable \</span>
<span class="w">            </span><span class="no">--cluster dealsphere-${{ env.ENVIRONMENT }} \</span>
<span class="w">            </span><span class="no">--services dealsphere-backend</span>
</code></pre></div>

<h2 id="monitoring-and-observability">Monitoring and Observability<a class="headerlink" href="#monitoring-and-observability" title="Permanent link">&para;</a></h2>
<h3 id="cloud-native-monitoring">Cloud-Native Monitoring<a class="headerlink" href="#cloud-native-monitoring" title="Permanent link">&para;</a></h3>
<p><strong>AWS CloudWatch:</strong>
- Application logs and metrics
- Custom dashboards and alarms
- Integration with ECS and RDS</p>
<p><strong>GCP Cloud Monitoring:</strong>
- GKE cluster monitoring
- Application performance monitoring
- Log aggregation with Cloud Logging</p>
<p><strong>Azure Monitor:</strong>
- AKS monitoring with Container Insights
- Application Insights for APM
- Log Analytics workspace</p>
<h3 id="example-cloudwatch-dashboard">Example CloudWatch Dashboard<a class="headerlink" href="#example-cloudwatch-dashboard" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;widgets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;metric&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;metrics&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">[</span><span class="s2">&quot;AWS/ECS&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;CPUUtilization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ServiceName&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;dealsphere-backend&quot;</span><span class="p">],</span>
<span class="w">          </span><span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MemoryUtilization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;period&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;stat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Average&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;region&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ECS Service Metrics&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SOURCE &#39;/ecs/dealsphere-production&#39; | fields @timestamp, @message\n| filter @message like /ERROR/\n| sort @timestamp desc\n| limit 20&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;region&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Recent Errors&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="cost-optimization">Cost Optimization<a class="headerlink" href="#cost-optimization" title="Permanent link">&para;</a></h2>
<h3 id="aws-cost-optimization">AWS Cost Optimization<a class="headerlink" href="#aws-cost-optimization" title="Permanent link">&para;</a></h3>
<p><strong>Reserved Instances:</strong>
- RDS Reserved Instances for database
- EC2 Reserved Instances for predictable workloads
- ECS Fargate Savings Plans</p>
<p><strong>Resource Scheduling:</strong>
- Auto Scaling for ECS services
- RDS instance scheduling for non-production
- CloudFront edge caching</p>
<p><strong>Storage Optimization:</strong>
- S3 Intelligent Tiering
- EBS GP3 storage type
- Regular snapshot cleanup</p>
<h3 id="multi-cloud-cost-comparison">Multi-Cloud Cost Comparison<a class="headerlink" href="#multi-cloud-cost-comparison" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>AWS</th>
<th>GCP</th>
<th>Azure</th>
<th>Digital Ocean</th>
</tr>
</thead>
<tbody>
<tr>
<td>Compute (2 vCPU, 8GB)</td>
<td>$140/mo</td>
<td>$130/mo</td>
<td>$135/mo</td>
<td>$96/mo</td>
</tr>
<tr>
<td>Database (Small)</td>
<td>$85/mo</td>
<td>$75/mo</td>
<td>$80/mo</td>
<td>$60/mo</td>
</tr>
<tr>
<td>Load Balancer</td>
<td>$18/mo</td>
<td>$15/mo</td>
<td>$20/mo</td>
<td>$12/mo</td>
</tr>
<tr>
<td>Storage (100GB)</td>
<td>$10/mo</td>
<td>$10/mo</td>
<td>$12/mo</td>
<td>$10/mo</td>
</tr>
<tr>
<td><strong>Total (Est.)</strong></td>
<td><strong>$253/mo</strong></td>
<td><strong>$230/mo</strong></td>
<td><strong>$247/mo</strong></td>
<td><strong>$178/mo</strong></td>
</tr>
</tbody>
</table>
<h2 id="disaster-recovery">Disaster Recovery<a class="headerlink" href="#disaster-recovery" title="Permanent link">&para;</a></h2>
<h3 id="multi-region-setup">Multi-Region Setup<a class="headerlink" href="#multi-region-setup" title="Permanent link">&para;</a></h3>
<p><strong>AWS Multi-Region:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Primary region: us-west-2</span>
<span class="c1"># DR region: us-east-1</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket_replication_configuration&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.main.id</span>
<span class="w">  </span><span class="na">role</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.replication.arn</span>

<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;replicate-to-dr&quot;</span>
<span class="w">    </span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enabled&quot;</span>

<span class="w">    </span><span class="nb">destination</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.dr.arn</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RDS Cross-Region Automated Backups</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_db_instance_automated_backups_replication&quot;</span><span class="w"> </span><span class="nv">&quot;main&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source_db_instance_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_db_instance.main.arn</span>
<span class="w">  </span><span class="na">kms_key_id</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_kms_key.dr.arn</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="backup-and-recovery-procedures">Backup and Recovery Procedures<a class="headerlink" href="#backup-and-recovery-procedures" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Database Backups</strong>: Automated daily backups with cross-region replication</li>
<li><strong>Application State</strong>: Stateless applications with external state storage</li>
<li><strong>Configuration</strong>: Infrastructure as Code in version control</li>
<li><strong>Monitoring</strong>: Health checks and automated failover procedures</li>
</ol>
<h2 id="security-best-practices">Security Best Practices<a class="headerlink" href="#security-best-practices" title="Permanent link">&para;</a></h2>
<h3 id="infrastructure-security">Infrastructure Security<a class="headerlink" href="#infrastructure-security" title="Permanent link">&para;</a></h3>
<p><strong>Network Security:</strong>
- VPC with private subnets for databases
- Security groups with least privilege access
- WAF for web application protection</p>
<p><strong>Encryption:</strong>
- Encryption at rest for all storage
- TLS 1.2+ for all communication
- KMS/Key Vault for key management</p>
<p><strong>Access Control:</strong>
- IAM roles with minimal permissions
- Service accounts for application access
- Multi-factor authentication for admin access</p>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<h3 id="common-cloud-issues">Common Cloud Issues<a class="headerlink" href="#common-cloud-issues" title="Permanent link">&para;</a></h3>
<p><strong>ECS/EKS Task Failures:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check task logs</span>
aws<span class="w"> </span>ecs<span class="w"> </span>describe-tasks<span class="w"> </span>--cluster<span class="w"> </span>my-cluster<span class="w"> </span>--tasks<span class="w"> </span>task-id
kubectl<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>deployment/my-app

<span class="c1"># Check service events</span>
aws<span class="w"> </span>ecs<span class="w"> </span>describe-services<span class="w"> </span>--cluster<span class="w"> </span>my-cluster<span class="w"> </span>--services<span class="w"> </span>my-service
kubectl<span class="w"> </span>describe<span class="w"> </span>deployment<span class="w"> </span>my-app
</code></pre></div>

<p><strong>Database Connection Issues:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Test connectivity</span>
telnet<span class="w"> </span>db-endpoint<span class="w"> </span><span class="m">5432</span>
nslookup<span class="w"> </span>db-endpoint

<span class="c1"># Check security groups</span>
aws<span class="w"> </span>ec2<span class="w"> </span>describe-security-groups<span class="w"> </span>--group-ids<span class="w"> </span>sg-xxxxx
</code></pre></div>

<p><strong>SSL Certificate Issues:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check certificate status</span>
aws<span class="w"> </span>acm<span class="w"> </span>list-certificates
gcloud<span class="w"> </span>compute<span class="w"> </span>ssl-certificates<span class="w"> </span>list
az<span class="w"> </span>network<span class="w"> </span>application-gateway<span class="w"> </span>ssl-cert<span class="w"> </span>list
</code></pre></div>

<h2 id="related-documentation">Related Documentation<a class="headerlink" href="#related-documentation" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../production-deployment/">Production Deployment</a></li>
<li><a href="../environment-management/">Environment Management</a></li>
<li><a href="security-secrets-management.md">Security and Secrets Management</a></li>
<li><a href="../observability-monitoring/">Observability and Monitoring</a></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/DealSphere-Inc" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "toc.integrate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>